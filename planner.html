<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ó–∞–Ω—è—Ç–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ ‚Äî Monexa</title>
<script src="https://api.bitrix24.com/api/v1/"></script>
<script>
// –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ BX24 –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
window.addEventListener('DOMContentLoaded', () => {
  if (typeof BX24 === 'undefined') {
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Inter,sans-serif;text-align:center;padding:40px;">
        <div>
          <h2 style="margin-bottom:16px;">‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ –ë–∏—Ç—Ä–∏–∫—Å24</h2>
          <p style="color:#6b7280;max-width:500px;line-height:1.6;">
            –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç BX24 JS SDK –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–∞–∫<br>
            <b>–õ–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</b> –≤–Ω—É—Ç—Ä–∏ –ë–∏—Ç—Ä–∏–∫—Å24 (–≤ iframe).<br><br>
            –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º ‚Üí –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Üí —É–∫–∞–∂–∏—Ç–µ URL —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞.
          </p>
        </div>
      </div>`;
  }
});
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

:root{
  --bg:#f5f7fa;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --line:#e5e7eb;
  --line2:#f3f4f6;
  --brand:#6366f1;

  --panelw: 440px; /* —à–∏—Ä–∏–Ω–∞ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
}

body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow: hidden;
  height: 100vh;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –®–ê–ü–ö–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.header {
  height: 56px;
  background: var(--card);
  border-bottom: 1px solid var(--line);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  z-index: 100;
  position: relative;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.header-title {
  font-size: 16px;
  font-weight: 800;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.header-title svg { width: 20px; height: 20px; color: var(--brand); }

.header-badge {
  font-size: 11px;
  font-weight: 700;
  background: #eef2ff;
  color: var(--brand);
  padding: 2px 8px;
  border-radius: 8px;
}

/* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º */
.nav-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.nav-btn {
  width: 32px; height: 32px;
  border-radius: 10px;
  border: 1px solid var(--line);
  background: var(--card);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  color: var(--muted);
}
.nav-btn:hover { background: var(--line2); color: var(--text); border-color: #d1d5db; }

.nav-date {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  min-width: 220px;
  text-align: center;
  cursor: pointer;
  padding: 4px 12px;
  border-radius: 8px;
  transition: all 0.15s;
  user-select: none;
  position: relative;
}
.nav-date:hover { background: var(--line2); }

.btn-today {
  height: 32px;
  padding: 0 14px;
  border-radius: 10px;
  border: 1px solid var(--brand);
  background: var(--card);
  color: var(--brand);
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.15s;
  font-family: inherit;
}
.btn-today:hover { background: var(--brand); color: #fff; }

.btn-refresh {
  width: 32px; height: 32px;
  border-radius: 10px;
  border: 1px solid var(--line);
  background: var(--card);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  color: var(--muted);
}
.btn-refresh:hover { background: var(--line2); color: var(--text); }
.btn-refresh.spinning svg { animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –û–°–ù–û–í–ù–ê–Ø –°–ï–¢–ö–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.planner {
  display: flex;
  height: calc(100vh - 56px);
  overflow: hidden;
}

/* –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –∏–º–µ–Ω–∞ */
.sidebar {
  width: 220px;
  min-width: 220px;
  background: var(--card);
  border-right: 1px solid var(--line);
  display: flex;
  flex-direction: column;
  z-index: 10;
}

.sidebar-header {
  height: 44px;
  min-height: 44px;
  display: flex;
  align-items: center;
  padding: 0 16px;
  border-bottom: 1px solid var(--line);
  font-size: 12px;
  font-weight: 800;
  color: #9ca3af;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  background: #fafbfc;
}

.sidebar-list {
  flex: 1;
  overflow-y: auto;
  scrollbar-width: none;
}
.sidebar-list::-webkit-scrollbar { display: none; }

.sidebar-user {
  height: 36px;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 0 12px;
  border-bottom: 1px solid var(--line2);
  font-size: 12.5px;
  color: #374151;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  transition: background 0.1s;
}
.sidebar-user:hover { background: #f9fafb; }

.sidebar-avatar {
  width: 22px; height: 22px;
  border-radius: 7px;
  background: #e5e7eb;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 800;
  color: var(--muted);
  flex-shrink: 0;
  overflow: hidden;
}
.sidebar-avatar img { width: 100%; height: 100%; object-fit: cover; }

.sidebar-name {
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 600;
}

/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å ‚Äî —Ç–∞–π–º–ª–∞–π–Ω */
.timeline-wrapper {
  flex: 1;
  overflow: auto;
  position: relative;
}

.timeline-wrapper::-webkit-scrollbar { width: 8px; height: 8px; }
.timeline-wrapper::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
.timeline-wrapper::-webkit-scrollbar-corner { background: transparent; }

.timeline { position: relative; min-width: fit-content; }

/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π */
.timeline-header {
  height: 44px;
  display: flex;
  position: sticky;
  top: 0;
  z-index: 5;
  background: #fafbfc;
  border-bottom: 1px solid var(--line);
}

.day-header {
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--line);
}

.day-title {
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 800;
  color: var(--muted);
  border-bottom: 1px solid var(--line2);
}
.day-title.today { color: var(--brand); }
.day-title.weekend { color: #ef4444; opacity: 0.75; }

.day-title .today-dot {
  width: 6px; height: 6px;
  background: var(--brand);
  border-radius: 50%;
  margin-left: 6px;
}

.day-hours { height: 22px; display: flex; }
.hour-cell {
  display: flex;
  align-items: center;
  justify-content: center;
  color: #9ca3af;
  font-weight: 600;
  border-right: 1px solid var(--line2);
  overflow: hidden;
}

/* –°–µ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π */
.timeline-body { position: relative; }

.timeline-row {
  height: 36px;
  display: flex;
  position: relative;
  border-bottom: 1px solid var(--line2);
}
.timeline-row:hover { background: rgba(99,102,241,0.02); }

/* –î–Ω–µ–≤–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: –º—è–≥–∫–∞—è —Å–µ—Ç–∫–∞ —á–µ—Ä–µ–∑ background */
.day-column {
  position: relative;
  border-right: 1px solid var(--line);
  display: flex;
  overflow: hidden;
  background-color: #fff;
}

/* –ú—è–≥–∫–∏–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ –ø–æ —á–∞—Å–∞–º */
.day-column::before{
  content:'';
  position:absolute;
  inset:0;
  background-image: linear-gradient(to right, rgba(229,231,235,0.95) 1px, transparent 1px);
  background-size: var(--hourw) 100%;
  opacity: 0.55;
  pointer-events:none;
  z-index: 0;
}

/* –û—á–µ–Ω—å –Ω–µ–∂–Ω—ã–µ 30-–º–∏–Ω—É—Ç–Ω—ã–µ */
.day-column::after{
  content:'';
  position:absolute;
  inset:0;
  background-image: linear-gradient(to right, rgba(243,244,246,0.95) 1px, transparent 1px);
  background-size: calc(var(--hourw) / 2) 100%;
  opacity: 0.18;
  pointer-events:none;
  z-index: 0;
}

.day-column.weekend { background: rgba(0,0,0,0.012); }
.day-column.today-col { background: rgba(99,102,241,0.02); }

/* –°–ª–æ—Ç—ã —á–∞—Å–æ–≤ (–¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤) */
.hour-slot { position: relative; z-index: 1; }

/* –°–æ–±—ã—Ç–∏—è ‚Äî –¢–û–õ–¨–ö–û –¶–í–ï–¢, –ë–ï–ó –¢–ï–ö–°–¢–ê */
.event-block {
  position: absolute;
  height: 22px;
  top: 7px;
  border-radius: 7px;
  cursor: pointer;
  z-index: 2;
  transition: filter 0.15s, transform 0.1s, box-shadow 0.15s;
  min-width: 8px;
  backdrop-filter: blur(2px);
}
.event-block:hover {
  filter: brightness(0.95);
  transform: scaleY(1.10);
  z-index: 3;
}
.event-block.active{
  box-shadow: 0 0 0 2px rgba(99,102,241,0.30), 0 10px 20px rgba(0,0,0,0.08);
}

/* –õ–∏–Ω–∏—è ¬´—Å–µ–π—á–∞—Å¬ª */
.now-line {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 2px;
  background: #ef4444;
  z-index: 4;
  pointer-events: none;
}
.now-line::before {
  content: '';
  position: absolute;
  top: -3px;
  left: -3px;
  width: 8px;
  height: 8px;
  background: #ef4444;
  border-radius: 50%;
}

/* –¢—É–ª—Ç–∏–ø –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.tooltip {
  position: fixed;
  background: #111827;
  color: #fff;
  padding: 7px 10px;
  border-radius: 10px;
  font-size: 11px;
  line-height: 1.35;
  max-width: 360px;
  z-index: 999;
  pointer-events: none;
  box-shadow: 0 10px 25px rgba(0,0,0,0.28);
  display: none;
  white-space: nowrap;
}
.tooltip.show { display: block; }

/* –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤ */
.legend {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-left: 16px;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--muted);
  font-weight: 700;
}
.legend-dot {
  width: 10px; height: 10px;
  border-radius: 3px;
}

/* –õ–æ–∞–¥–µ—Ä */
.loader-overlay {
  position: absolute;
  inset: 0;
  background: rgba(255,255,255,0.88);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 50;
  gap: 12px;
}
.loader-overlay.hidden { display: none; }
.loader-spinner {
  width: 28px; height: 28px;
  border: 3px solid var(--line);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
.loader-text { font-size: 13px; color: var(--muted); font-weight: 700; }

/* Toast */
.toast {
  position: fixed;
  right: 16px;
  bottom: 16px;
  background: #111827;
  color: #fff;
  padding: 10px 12px;
  border-radius: 14px;
  font-size: 12px;
  box-shadow: 0 14px 40px rgba(0,0,0,0.25);
  display: none;
  max-width: 420px;
  line-height: 1.35;
  z-index: 2000;
}
.toast.show { display: block; }
.toast b { font-weight: 800; }
.toast .muted { color: rgba(255,255,255,0.75); font-weight: 700; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ –î–ï–¢–ê–õ–ï–ô ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.details-panel{
  width: 0;
  min-width: 0;
  border-left: 1px solid var(--line);
  background: var(--card);
  overflow: hidden;
  transition: width 0.18s ease, min-width 0.18s ease;
  display: flex;
  flex-direction: column;
  z-index: 20;
}
.details-panel.open{
  width: var(--panelw);
  min-width: var(--panelw);
}

.details-header{
  height: 56px;
  padding: 14px 14px 10px;
  border-bottom: 1px solid var(--line2);
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 10px;
}
.details-title{
  font-size: 14px;
  font-weight: 900;
  line-height: 1.2;
  color: var(--text);
  max-width: calc(var(--panelw) - 90px);
  overflow:hidden;
  text-overflow: ellipsis;
  display:-webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.details-close{
  width: 32px; height: 32px;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: #fff;
  cursor:pointer;
  font-size: 16px;
  color: var(--muted);
  display:flex;
  align-items:center;
  justify-content:center;
}
.details-close:hover{ background: var(--line2); color: var(--text); }

.details-body{
  padding: 12px 14px 14px;
  overflow: auto;
  height: calc(100% - 56px);
}

.details-row{
  display:grid;
  grid-template-columns: 18px 90px 1fr;
  gap: 10px;
  padding: 10px 0;
  border-bottom: 1px solid #f6f7fb;
  align-items: start;
  font-size: 13px;
}
.details-row:last-child{ border-bottom: none; }

.details-ic{ text-align:center; color:#9ca3af; padding-top: 1px; }
.details-lb{ color: var(--muted); font-weight: 800; }
.details-vl{ color: var(--text); font-weight: 600; min-width:0; }

.details-tags{
  display:flex; flex-wrap:wrap; gap:6px;
}
.details-tag{
  font-size: 11px;
  font-weight: 700;
  background: #f3f4f6;
  border: 1px solid rgba(0,0,0,0.04);
  color: #374151;
  padding: 4px 8px;
  border-radius: 10px;
}

.details-desc{
  max-height: 320px;
  overflow: auto;
  padding: 10px 10px;
  border-radius: 14px;
  background: #fafafa;
  border: 1px solid #f1f5f9;
  white-space: pre-wrap;
  word-break: break-word;
  line-height: 1.45;
}

.details-desc a{
  color: var(--brand);
  text-decoration: none;
  font-weight: 600;
  background: #eef2ff;
  padding: 1px 6px;
  border-radius: 4px;
  word-break: break-all;
  transition: all 0.15s;
}
.details-desc a:hover{ text-decoration: underline; background: #e0e7ff; }

.desc-hr {
  border: none;
  border-top: 1px solid #e5e7eb;
  margin: 8px 0;
}

.details-color{
  display:flex; align-items:center; gap:10px;
}
.details-color-dot{
  width: 12px; height: 12px; border-radius: 4px;
  border: 1px solid rgba(0,0,0,0.06);
}

.details-actions{
  display:flex;
  gap:10px;
  margin-top: 10px;
}
.btn-ghost{
  height: 32px;
  padding: 0 12px;
  border-radius: 10px;
  border: 1px solid var(--line);
  background: #fff;
  color: var(--text);
  font-weight: 800;
  font-size: 12px;
  cursor: pointer;
}
.btn-ghost:hover{ background: var(--line2); }

.details-empty{
  color: var(--muted);
  font-weight: 700;
  font-size: 13px;
  display:flex;
  align-items:center;
  justify-content:center;
  height: 100%;
  text-align:center;
  padding: 20px;
}

/* Backdrop (–¥–ª—è –º–æ–±–∏–ª–∫–∏/–æ–≤–µ—Ä–ª–µ—è) */
.details-backdrop{
  position: fixed;
  inset: 56px 0 0 0;
  background: rgba(0,0,0,0.25);
  z-index: 19;
  display:none;
}

/* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è: –ø–∞–Ω–µ–ª—å –ø–æ–≤–µ—Ä—Ö */
@media (max-width: 980px){
  :root{ --panelw: 92vw; }
  .details-panel{
    position: fixed;
    top: 56px; right: 0; bottom: 0;
    height: calc(100vh - 56px);
    border-left: 1px solid var(--line);
    box-shadow: -20px 0 60px rgba(0,0,0,0.22);
  }
  .details-panel.open{ width: var(--panelw); min-width: var(--panelw); }
  .details-backdrop.show{ display:block; }
}
</style>
</head>

<body>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ö–û–ù–§–ò–ì ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CFG = {
  WORK_START: 9,
  WORK_END: 19,
  HOUR_WIDTH: 60,
  DAYS_SHOW: 7,

  EXCLUDE_USERS: ['–°–∫–ª–∞–¥', '–î–ª—è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏'],
  EXCLUDE_IDS: [744, 382, 510],
};
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –®–ê–ü–ö–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="header">
  <div class="header-left">
    <div class="header-title">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      –ó–∞–Ω—è—Ç–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    </div>
    <span class="header-badge" id="userCount">‚Äî</span>

    <div class="legend">
      <span class="legend-item"><span class="legend-dot" style="background:#fca5a5;border:1px solid #f87171"></span>–í—Å—Ç—Ä–µ—á–∞</span>
      <span class="legend-item"><span class="legend-dot" style="background:#93c5fd;border:1px solid #60a5fa"></span>–°–æ–∑–≤–æ–Ω</span>
      <span class="legend-item"><span class="legend-dot" style="background:#a5f3c4;border:1px solid #6ee7a0"></span>–ó–∞–¥–∞—á–∞</span>
      <span class="legend-item"><span class="legend-dot" style="background:#fde68a;border:1px solid #fbbf24"></span>–°–æ–±—ã—Ç–∏–µ</span>
      <span class="legend-item"><span class="legend-dot" style="background:#c4b5fd;border:1px solid #a78bfa"></span>–î—Ä—É–≥–æ–µ</span>
    </div>
  </div>

  <div class="nav-group">
    <button class="nav-btn" onclick="navigate(-1)" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </button>
    <span class="nav-date" id="navDate" onclick="openDatePicker()" title="–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É">‚Äî</span>
    <input type="date" id="datePicker" style="position:absolute;opacity:0;pointer-events:none;width:0;height:0;" onchange="onDatePicked(this.value)">
    <button class="nav-btn" onclick="navigate(1)" title="–°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </button>
    <button class="btn-today" onclick="goToday()">–°–µ–≥–æ–¥–Ω—è</button>
    <button class="btn-refresh" id="btnRefresh" onclick="loadData()" title="–û–±–Ω–æ–≤–∏—Ç—å">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="23 4 23 10 17 10"/>
        <polyline points="1 20 1 14 7 14"/>
        <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
      </svg>
    </button>
    <button class="nav-btn" onclick="autoFitScale();render();" title="–í–ø–∏—Å–∞—Ç—å –≤ —ç–∫—Ä–∞–Ω" style="font-size:10px;width:auto;padding:0 8px;">‚äû Fit</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–õ–ê–ù–ù–ï–† ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="planner">
  <div class="sidebar">
    <div class="sidebar-header">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div>
    <div class="sidebar-list" id="sidebarList"></div>
  </div>

  <div class="timeline-wrapper" id="timelineWrapper">
    <div class="timeline" id="timeline">
      <div class="timeline-header" id="timelineHeader"></div>
      <div class="timeline-body" id="timelineBody"></div>
    </div>

    <div class="loader-overlay" id="loader">
      <div class="loader-spinner"></div>
      <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å –¥–µ—Ç–∞–ª–µ–π -->
  <div class="details-panel" id="detailsPanel" aria-hidden="true">
    <div class="details-header">
      <div class="details-title" id="detailsTitle">–î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏—è</div>
      <button class="details-close" onclick="closeDetails()" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
    </div>
    <div class="details-body" id="detailsBody">
      <div class="details-empty">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏–µ –Ω–∞ —Å–µ—Ç–∫–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏.</div>
    </div>
  </div>
</div>

<div class="details-backdrop" id="detailsBackdrop" onclick="closeDetails()"></div>

<!-- –¢—É–ª—Ç–∏–ø -->
<div class="tooltip" id="tooltip"></div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–û–°–¢–û–Ø–ù–ò–ï ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentMonday = getMonday(new Date());
let users = [];
let events = {}; // { userId: [events] }
let activeEventEl = null;

const WEEKDAYS = ['–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ','–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞'];
const MONTHS = ['—è–Ω–≤–∞—Ä—è','—Ñ–µ–≤—Ä–∞–ª—è','–º–∞—Ä—Ç–∞','–∞–ø—Ä–µ–ª—è','–º–∞—è','–∏—é–Ω—è','–∏—é–ª—è','–∞–≤–≥—É—Å—Ç–∞','—Å–µ–Ω—Ç—è–±—Ä—è','–æ–∫—Ç—è–±—Ä—è','–Ω–æ—è–±—Ä—è','–¥–µ–∫–∞–±—Ä—è'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –£–¢–ò–õ–ò–¢–´ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hoursCount(){ return CFG.WORK_END - CFG.WORK_START; }
function dayWidth(){ return hoursCount() * CFG.HOUR_WIDTH; }

function getMonday(d) {
  const dt = new Date(d);
  const day = dt.getDay();
  const diff = dt.getDate() - day + (day === 0 ? -6 : 1);
  dt.setDate(diff);
  dt.setHours(0,0,0,0);
  return dt;
}

function addDays(d, n) {
  const r = new Date(d);
  r.setDate(r.getDate() + n);
  return r;
}

function fmtDate(d) {
  return String(d.getDate()).padStart(2,'0') + '.' +
    String(d.getMonth()+1).padStart(2,'0') + '.' +
    d.getFullYear();
}

function sameDay(a, b) {
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function isWeekend(d) {
  return d.getDay()===0 || d.getDay()===6;
}

function parseBxDate(s) {
  if (!s) return new Date(0);
  const m = s.match(/^(\d{2})\.(\d{2})\.(\d{4})\s+(\d{2}):(\d{2}):(\d{2})$/);
  if (m) return new Date(+m[3], +m[2]-1, +m[1], +m[4], +m[5], +m[6]);
  const d = new Date(s);
  if (!isNaN(d.getTime())) return d;
  return new Date(0);
}

function initials(name) {
  return (name || '').split(' ').filter(Boolean).map(w => w[0]).join('').substring(0,2).toUpperCase();
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function showToast(title, details='') {
  const t = document.getElementById('toast');
  t.innerHTML = `<b>${esc(title)}</b><div class="muted">${esc(details)}</div>`;
  t.classList.add('show');
  clearTimeout(showToast._tm);
  showToast._tm = setTimeout(()=>t.classList.remove('show'), 5200);
}

// URL ‚Üí —Å—Å—ã–ª–∫–∏ (–±–µ–∑–æ–ø–∞—Å–Ω–æ: —Å–Ω–∞—á–∞–ª–∞ escape, –ø–æ—Ç–æ–º linkify)
function linkifySafe(text) {
  if (!text) return '';
  // 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º BB-code: [URL=https://...]—Ç–µ–∫—Å—Ç[/URL]
  let t = text.replace(/\[URL=(.*?)\](.*?)\[\/URL\]/gi, (_, url, label) => {
    return `%%LINK%%${url}%%SEP%%${label}%%ENDLINK%%`;
  });
  // 2. –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML
  t = esc(t);
  // 3. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫–∏ –∏–∑ BB-code
  t = t.replace(/%%LINK%%(.*?)%%SEP%%(.*?)%%ENDLINK%%/g, (_, url, label) => {
    const cleanUrl = url.replace(/&amp;/g, '&');
    const short = label.length > 45 ? label.substring(0, 42) + '...' : label;
    return `<a href="${cleanUrl}" target="_blank" rel="noopener noreferrer" class="desc-link">${short}</a>`;
  });
  // 4. –ê–≤—Ç–æ–ª–∏–Ω–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è URL (–Ω–µ –≤–Ω—É—Ç—Ä–∏ —Ç–µ–≥–æ–≤)
  t = t.replace(/(?<!href="|">)(https?:\/\/[^\s<>"']+)/g, (m) => {
    const url = m.replace(/&amp;/g, '&');
    const short = m.length > 50 ? m.substring(0, 47) + '...' : m;
    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="desc-link">${short}</a>`;
  });
  // 5. –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
  t = t.replace(/\n/g, '<br>');
  // 6. –£–±–∏—Ä–∞–µ–º --- —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
  t = t.replace(/(<br>)?-{3,}(<br>)?/g, '<hr class="desc-hr">');
  return t;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API (BX24 JS SDK) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function apiCall(method, params = {}) {
  return new Promise((resolve) => {
    BX24.callMethod(method, params, (res) => {
      if (res.error()) {
        console.error('API error:', method, res.error());
        resolve({ error: res.error() });
      } else {
        // –≠–º—É–ª–∏—Ä—É–µ–º —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ —É REST webhook
        const answer = res.answer;
        resolve({
          result: res.data(),
          total: answer?.total,
          next: answer?.next,
        });
      }
    });
  });
}

function apiBatch(cmd) {
  return new Promise((resolve) => {
    // BX24.callBatch –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—ä–µ–∫—Ç {key: [method, params]}
    const calls = {};
    for (const key in cmd) {
      // cmd[key] = "calendar.event.get?from=...&to=...&type=user&ownerId=22"
      const raw = cmd[key];
      const qIdx = raw.indexOf('?');
      const method = qIdx === -1 ? raw : raw.substring(0, qIdx);
      const paramsStr = qIdx === -1 ? '' : raw.substring(qIdx + 1);
      const params = {};
      if (paramsStr) {
        paramsStr.split('&').forEach(pair => {
          const [k, v] = pair.split('=');
          params[decodeURIComponent(k)] = decodeURIComponent(v || '');
        });
      }
      calls[key] = [method, params];
    }

    BX24.callBatch(calls, (results) => {
      const resultObj = {};
      const resultError = {};
      for (const key in results) {
        if (results[key].error()) {
          resultError[key] = results[key].error();
        } else {
          resultObj[key] = results[key].data();
        }
      }
      resolve({
        result: { result: resultObj, result_error: Object.keys(resultError).length ? resultError : undefined },
      });
    }, false);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ó–ê–ì–†–£–ó–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadUsers() {
  let allUsers = [];
  let start = 0;

  while (true) {
    const data = await apiCall('user.get', { ACTIVE: true, start });
    if (data && data.result) allUsers = allUsers.concat(data.result);

    if (!data || data.error) break;
    if (!data.next) break;
    start = data.next;
  }

  users = allUsers
    .filter(u => u.ACTIVE && u.USER_TYPE !== 'extranet')
    .filter(u => !CFG.EXCLUDE_IDS.includes(parseInt(u.ID)))
    .filter(u => !CFG.EXCLUDE_USERS.some(n => ((u.LAST_NAME + ' ' + u.NAME) || '').includes(n)))
    .map(u => ({
      id: parseInt(u.ID),
      name: [u.LAST_NAME, u.NAME].filter(Boolean).join(' ') || u.EMAIL || ('User ' + u.ID),
      photo: u.PERSONAL_PHOTO || '',
    }))
    .sort((a,b) => a.name.localeCompare(b.name, 'ru'));

  document.getElementById('userCount').textContent = users.length ? (users.length + ' —á–µ–ª.') : '‚Äî';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ó–ê–ì–†–£–ó–ö–ê –°–û–ë–´–¢–ò–ô ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadEvents() {
  const from = fmtDate(currentMonday);
  const to = fmtDate(addDays(currentMonday, CFG.DAYS_SHOW));
  events = {};

  // –ë–∞—Ç—á–∏ –ø–æ 50
  const chunks = [];
  for (let i = 0; i < users.length; i += 50) chunks.push(users.slice(i, i + 50));

  for (const chunk of chunks) {
    const cmd = {};
    chunk.forEach(u => {
      cmd['u' + u.id] = `calendar.event.get?type=user&ownerId=${u.id}&from=${from}&to=${to}`;
    });

    const data = await apiBatch(cmd);
    if (!data || data.error) continue;

    if (data.result && data.result.result) {
      const results = data.result.result;
      for (const key of Object.keys(results)) {
        const uid = parseInt(key.replace('u',''));
        const evts = results[key];
        if (Array.isArray(evts) && evts.length) {
          events[uid] = evts.map(e => ({
            id: e.ID,
            name: e.NAME || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
            from: parseBxDate(e.DATE_FROM),
            to: parseBxDate(e.DATE_TO),
            bxColor: e.COLOR || '',
            location: (e.LOCATION || '').replace(/^calendar_\d+$/, ''),
            description: e.DESCRIPTION || '',
            importance: e.IMPORTANCE || 'normal',
            accessibility: e.ACCESSIBILITY || '',
            creator: e.CREATED_BY || '',
            attendees: (e.attendeesEntityList || []).map(a => a.id),
          }));
        }
      }
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –†–ï–ù–î–ï–† ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function autoFitScale() {
  const available = window.innerWidth - 220; // sidebar width
  // –í–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ü–Ω‚Äì–ü—Ç (5 –¥–Ω–µ–π), –°–±-–í—Å –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫—É
  const workDays = Math.min(CFG.DAYS_SHOW, 5);
  const totalHours = workDays * hoursCount();
  CFG.HOUR_WIDTH = Math.max(Math.floor(available / totalHours), 20);
}

function zoomScale(dir) {} // deprecated

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –í–´–ë–û–† –î–ê–¢–´ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDatePicker() {
  const picker = document.getElementById('datePicker');
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∫–∞–∫ –∑–Ω–∞—á–µ–Ω–∏–µ
  const today = new Date();
  picker.value = fmtDateISO(today);
  picker.showPicker();
}

function onDatePicked(val) {
  if (!val) return;
  const parts = val.split('-');
  const picked = new Date(parseInt(parts[0]), parseInt(parts[1])-1, parseInt(parts[2]));
  if (isNaN(picked.getTime())) return;
  currentMonday = getMonday(picked);
  closeDetails();
  loadData();
}

function fmtDateISO(d) {
  return d.getFullYear() + '-' +
    String(d.getMonth()+1).padStart(2,'0') + '-' +
    String(d.getDate()).padStart(2,'0');
}

// –ü–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
window.addEventListener('resize', () => {
  if (CFG._autoFit) { autoFitScale(); render(); }
});

function render() {
  document.documentElement.style.setProperty('--hourw', CFG.HOUR_WIDTH + 'px');
  renderNav();
  renderSidebar();
  renderTimeline();
  updateNowLine();
}

function renderNav() {
  const from = currentMonday;
  const to = addDays(currentMonday, CFG.DAYS_SHOW - 1);
  const text = `${from.getDate()} ${MONTHS[from.getMonth()]} ‚Äî ${to.getDate()} ${MONTHS[to.getMonth()]} ${to.getFullYear()}`;
  document.getElementById('navDate').textContent = text;
}

function renderSidebar() {
  const list = document.getElementById('sidebarList');
  list.innerHTML = users.map(u => `
    <div class="sidebar-user" data-uid="${u.id}">
      <div class="sidebar-avatar">
        ${u.photo ? `<img src="${u.photo}" alt="">` : initials(u.name)}
      </div>
      <span class="sidebar-name" title="${esc(u.name)}">${esc(u.name)}</span>
    </div>
  `).join('');
}

function renderTimeline() {
  const today = new Date();
  const days = [];
  for (let i = 0; i < CFG.DAYS_SHOW; i++) days.push(addDays(currentMonday, i));

  const DW = dayWidth();

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  const header = document.getElementById('timelineHeader');
  header.innerHTML = days.map(d => {
    const isToday = sameDay(d, today);
    const wkend = isWeekend(d);
    const dayName = WEEKDAYS[d.getDay()];
    const label = `${dayName}, ${d.getDate()} ${MONTHS[d.getMonth()].substring(0,3)}`;

    let hoursHtml = '';
    const fontSize = CFG.HOUR_WIDTH >= 55 ? 11 : CFG.HOUR_WIDTH >= 40 ? 9 : 7;
    for (let h = CFG.WORK_START; h < CFG.WORK_END; h++) {
      hoursHtml += `<div class="hour-cell" style="width:${CFG.HOUR_WIDTH}px;min-width:${CFG.HOUR_WIDTH}px;font-size:${fontSize}px">${h}:00</div>`;
    }

    return `<div class="day-header" style="width:${DW}px;min-width:${DW}px">
      <div class="day-title ${isToday ? 'today' : ''} ${wkend ? 'weekend' : ''}">
        ${label}${isToday ? '<span class="today-dot"></span>' : ''}
      </div>
      <div class="day-hours">${hoursHtml}</div>
    </div>`;
  }).join('');

  // –¢–µ–ª–æ
  const body = document.getElementById('timelineBody');
  body.innerHTML = users.map(u => {
    const userEvents = events[u.id] || [];

    const dayCols = days.map(d => {
      const isToday = sameDay(d, today);
      const wkend = isWeekend(d);

      // –°–ª–æ—Ç—ã —á–∞—Å–æ–≤ (—Ç–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—Ä—ã)
      let slotsHtml = '';
      for (let h = CFG.WORK_START; h < CFG.WORK_END; h++) {
        slotsHtml += `<div class="hour-slot" style="width:${CFG.HOUR_WIDTH}px;min-width:${CFG.HOUR_WIDTH}px"></div>`;
      }

      const dayStart = new Date(d); dayStart.setHours(CFG.WORK_START, 0, 0, 0);
      const dayEnd = new Date(d); dayEnd.setHours(CFG.WORK_END, 0, 0, 0);

      const evtsHtml = userEvents
        .filter(e => e.from < dayEnd && e.to > dayStart)
        .map(e => {
          const clampFrom = Math.max(e.from.getTime(), dayStart.getTime());
          const clampTo = Math.min(e.to.getTime(), dayEnd.getTime());
          const fromMin = (clampFrom - dayStart.getTime()) / 60000;
          const toMin = (clampTo - dayStart.getTime()) / 60000;

          const left = (fromMin / 60) * CFG.HOUR_WIDTH;
          const width = Math.max(((toMin - fromMin) / 60) * CFG.HOUR_WIDTH, 10);

          const bg = e.bxColor ? e.bxColor : getCategoryColor(e.name);
          const timeStr = e.from.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}) + '‚Äì' +
                          e.to.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});

          return `<div class="event-block"
            style="left:${left}px;width:${width}px;background:${hexToRgba(bg,0.33)};border:1px solid ${hexToRgba(bg,0.62)}"
            data-title="${esc(e.name)}"
            data-time="${esc(timeStr)}"
            data-uid="${u.id}"
            data-eid="${e.id}"
            onmouseenter="showTooltip(event,this)"
            onmouseleave="hideTooltip()"
            onclick="openDetails(${u.id}, '${e.id}', this)">
          </div>`;
        }).join('');

      return `<div class="day-column ${wkend ? 'weekend' : ''} ${isToday ? 'today-col' : ''}"
        style="width:${DW}px;min-width:${DW}px;">
        ${slotsHtml}${evtsHtml}
      </div>`;
    }).join('');

    return `<div class="timeline-row" data-uid="${u.id}">${dayCols}</div>`;
  }).join('');

  // –õ–∏–Ω–∏—è ¬´—Å–µ–π—á–∞—Å¬ª
  if (!document.getElementById('nowLine')) {
    const line = document.createElement('div');
    line.className = 'now-line';
    line.id = 'nowLine';
    body.appendChild(line);
  }
}

function updateNowLine() {
  const line = document.getElementById('nowLine');
  if (!line) return;

  const now = new Date();
  let dayOffset = -1;
  for (let i = 0; i < CFG.DAYS_SHOW; i++) {
    if (sameDay(addDays(currentMonday, i), now)) { dayOffset = i; break; }
  }

  if (dayOffset < 0 || now.getHours() < CFG.WORK_START || now.getHours() >= CFG.WORK_END) {
    line.style.display = 'none';
    return;
  }

  const minutesSinceStart = (now.getHours() - CFG.WORK_START) * 60 + now.getMinutes();
  const left = dayOffset * dayWidth() + (minutesSinceStart / 60) * CFG.HOUR_WIDTH;
  line.style.display = 'block';
  line.style.left = left + 'px';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –°–ö–†–û–õ–õ–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function syncScroll() {
  const wrapper = document.getElementById('timelineWrapper');
  const sidebar = document.getElementById('sidebarList');

  wrapper.addEventListener('scroll', () => { sidebar.scrollTop = wrapper.scrollTop; });
  sidebar.addEventListener('scroll', () => { wrapper.scrollTop = sidebar.scrollTop; });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –¢–£–õ–¢–ò–ü (–Ω–∞–≤–µ–¥–µ–Ω–∏–µ) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showTooltip(evt, el) {
  const tip = document.getElementById('tooltip');
  // –∫—Ä–∞—Ç–∫–æ: –Ω–∞–∑–≤–∞–Ω–∏–µ + –≤—Ä–µ–º—è (–∫–∞–∫ –≤—ã –ø—Ä–æ—Å–∏–ª–∏). –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏.
  tip.textContent = el.dataset.title + '  ' + el.dataset.time;
  tip.classList.add('show');
  tip.style.left = Math.min(evt.clientX + 12, window.innerWidth - 380) + 'px';
  tip.style.top = Math.max(evt.clientY - 34, 8) + 'px';
}
function hideTooltip() {
  document.getElementById('tooltip').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–∫–ª–∏–∫) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openDetails(userId, eventId, el){
  hideTooltip();

  // active highlight
  if (activeEventEl) activeEventEl.classList.remove('active');
  activeEventEl = el;
  if (activeEventEl) activeEventEl.classList.add('active');

  const userEvts = events[userId] || [];
  const evt = userEvts.find(e => e.id == eventId);
  if (!evt) return;
  _currentEvt = evt;

  const user = users.find(u => u.id === userId);
  const title = evt.name || '–°–æ–±—ã—Ç–∏–µ';

  document.getElementById('detailsTitle').textContent = title;

  const timeStr = evt.from.toLocaleDateString('ru-RU', {weekday:'short', day:'numeric', month:'short'}) +
    ', ' + evt.from.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}) + ' ‚Äî ' +
    evt.to.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});

  const durationMin = Math.max(0, Math.round((evt.to - evt.from) / 60000));
  const durStr = durationMin >= 60
    ? Math.floor(durationMin/60) + ' —á ' + (durationMin%60 ? durationMin%60 + ' –º–∏–Ω' : '')
    : durationMin + ' –º–∏–Ω';

  const accMap = { busy: 'üî¥ –ó–∞–Ω—è—Ç', quest: '‚ùì –ü–æ–¥ –≤–æ–ø—Ä–æ—Å–æ–º', free: 'üü¢ –°–≤–æ–±–æ–¥–µ–Ω', absent: 'üü° –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' };
  const accStr = accMap[evt.accessibility] || evt.accessibility || '‚Äî';

  let attendeesHtml = '';
  if (evt.attendees && evt.attendees.length > 0) {
    const names = evt.attendees.map(aid => {
      const u = users.find(x => x.id === aid);
      return u ? u.name : ('ID ' + aid);
    });
    attendeesHtml = `
      <div class="details-row">
        <div class="details-ic">üë•</div>
        <div class="details-lb">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
        <div class="details-vl">
          <div class="details-tags">${names.map(n => `<span class="details-tag">${esc(n)}</span>`).join('')}</div>
        </div>
      </div>`;
  }

  const clr = evt.bxColor || getCategoryColor(evt.name);

  const descHtml = evt.description
    ? `<div class="details-row">
         <div class="details-ic">üìù</div>
         <div class="details-lb">–û–ø–∏—Å–∞–Ω–∏–µ</div>
         <div class="details-vl"><div class="details-desc">${linkifySafe(evt.description)}</div></div>
       </div>`
    : '';

  document.getElementById('detailsBody').innerHTML = `
    <div class="details-row">
      <div class="details-ic">üïê</div>
      <div class="details-lb">–í—Ä–µ–º—è</div>
      <div class="details-vl">${esc(timeStr)}</div>
    </div>
    <div class="details-row">
      <div class="details-ic">‚è±</div>
      <div class="details-lb">–î–ª–∏—Ç.</div>
      <div class="details-vl">${esc(durStr)}</div>
    </div>
    <div class="details-row">
      <div class="details-ic">üìã</div>
      <div class="details-lb">–°—Ç–∞—Ç—É—Å</div>
      <div class="details-vl">${esc(accStr)}</div>
    </div>
    ${evt.location ? `
    <div class="details-row">
      <div class="details-ic">üìç</div>
      <div class="details-lb">–ú–µ—Å—Ç–æ</div>
      <div class="details-vl">${esc(evt.location)}</div>
    </div>` : ''}
    ${user ? `
    <div class="details-row">
      <div class="details-ic">üë§</div>
      <div class="details-lb">–°–æ—Ç—Ä.</div>
      <div class="details-vl">${esc(user.name)}</div>
    </div>` : ''}
    ${attendeesHtml}
    ${descHtml}
    <div class="details-row">
      <div class="details-ic">üé®</div>
      <div class="details-lb">–¶–≤–µ—Ç</div>
      <div class="details-vl">
        <div class="details-color">
          <span class="details-color-dot" style="background:${clr}"></span>
          <span>${esc(clr)}</span>
        </div>
        <div class="details-actions">
        <div class="details-actions">
          <button class="btn-ghost" onclick="copyEventDesc()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ</button>
          <button class="btn-ghost" onclick="copyEventTitle()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</button>
        </div>
      </div>
    </div>
  `;

  // open panel
  const panel = document.getElementById('detailsPanel');
  const backdrop = document.getElementById('detailsBackdrop');
  panel.classList.add('open');
  panel.setAttribute('aria-hidden','false');

  // backdrop only for mobile via CSS, –Ω–æ –∫–ª–∞—Å—Å –≤–∫–ª—é—á–∞–µ–º –≤—Å–µ–≥–¥–∞
  backdrop.classList.add('show');
}

function closeDetails(){
  const panel = document.getElementById('detailsPanel');
  const backdrop = document.getElementById('detailsBackdrop');
  panel.classList.remove('open');
  panel.setAttribute('aria-hidden','true');
  backdrop.classList.remove('show');

  if (activeEventEl) activeEventEl.classList.remove('active');
  activeEventEl = null;
}

function copyText(text){
  const t = (text || '').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>');
  navigator.clipboard?.writeText(t).then(
    () => showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', '–¢–µ–∫—Å—Ç –ø–æ–º–µ—â—ë–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.'),
    () => showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', '–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –¥–æ—Å—Ç—É–ø –∫ –±—É—Ñ–µ—Ä—É –æ–±–º–µ–Ω–∞.')
  );
}

// –¢–µ–∫—É—â–µ–µ –æ—Ç–∫—Ä—ã—Ç–æ–µ —Å–æ–±—ã—Ç–∏–µ
let _currentEvt = null;

function copyEventDesc() {
  if (_currentEvt) {
    // –£–±–∏—Ä–∞–µ–º BB-code –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —á–∏—Å—Ç–æ–π –∫–æ–ø–∏–∏
    let raw = (_currentEvt.description || '');
    raw = raw.replace(/\[URL=(.*?)\](.*?)\[\/URL\]/gi, '$1');
    raw = raw.replace(/\[URL=(.*?)\]/gi, '$1');
    copyText(raw);
  }
}
function copyEventTitle() {
  if (_currentEvt) copyText(_currentEvt.name || '');
}

// ESC –∑–∞–∫—Ä—ã–≤–∞–µ—Ç –ø–∞–Ω–µ–ª—å
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeDetails();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –¶–í–ï–¢–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCategoryColor(name) {
  const n = (name || '').toLowerCase();
  if (n.includes('zoom') || n.includes('—Å–æ–∑–≤–æ–Ω') || n.includes('call') || n.includes('–≤–∫—Å')) return '#60a5fa';
  if (n.includes('–≤—Å—Ç—Ä–µ—á–∞') || n.includes('–ø–µ—Ä–µ–≥–æ–≤–æ—Ä')) return '#f87171';
  if (n.includes('—Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ')) return '#a78bfa';
  if (n.includes('—Ñ–æ—Ä—É–º') || n.includes('–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è')) return '#34d399';
  if (n.includes('—Å–æ–≤–µ—â–∞–Ω–∏–µ')) return '#fb923c';
  return '#fbbf24';
}

function hexToRgba(hex, alpha) {
  hex = (hex || '').replace('#','');
  if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
  const r = parseInt(hex.substring(0,2),16) || 180;
  const g = parseInt(hex.substring(2,4),16) || 180;
  const b = parseInt(hex.substring(4,6),16) || 180;
  return `rgba(${r},${g},${b},${alpha})`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ù–ê–í–ò–ì–ê–¶–ò–Ø ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function navigate(dir) {
  currentMonday = addDays(currentMonday, dir * 7);
  closeDetails();
  loadData();
}

function goToday() {
  currentMonday = getMonday(new Date());
  closeDetails();
  loadData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–ö–†–û–õ–õ –ö ¬´–°–ï–ì–û–î–ù–Ø¬ª ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scrollToToday() {
  const wrapper = document.getElementById('timelineWrapper');
  // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ (–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
  wrapper.scrollLeft = 0;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –û–°–ù–û–í–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadData() {
  const loader = document.getElementById('loader');
  const btn = document.getElementById('btnRefresh');
  loader.classList.remove('hidden');
  btn.classList.add('spinning');

  try {
    if (users.length === 0) await loadUsers();
    if (users.length === 0) {
      showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', '–ü—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∞ –≤–µ–±—Ö—É–∫–∞ –Ω–∞ user.get.');
    } else {
      await loadEvents();
      autoFitScale();
      render();
      scrollToToday();
    }
  } catch (e) {
    console.error('Error:', e);
    showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', String(e?.message || e));
  }

  loader.classList.add('hidden');
  btn.classList.remove('spinning');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–∏ ¬´—Å–µ–π—á–∞—Å¬ª –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
setInterval(updateNowLine, 60000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –°–¢–ê–†–¢ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
syncScroll();

// –ñ–¥—ë–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ BX24 SDK
BX24.init(() => {
  console.log('BX24 SDK initialized');
  loadData();
});
</script>

</body>
</html>
